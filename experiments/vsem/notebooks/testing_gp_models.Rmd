---
title: "testing_gp_models"
output: html_document
---

```{r}
set.seed(543653)

library(data.table)
library(ggplot2)
library(patchwork)
library(scales)
library(grid)
library(support)

experiment_tag <- "vsem"

base_dir <- file.path("/projectnb", "dietzelab", "arober", "bip-surrogates-paper")
code_dir <- file.path("/projectnb", "dietzelab", "arober", "gp-calibration")
src_dir <- file.path(code_dir, "src")
experiment_dir <- file.path(base_dir, "experiments", experiment_tag)
out_dir <- file.path(experiment_dir, "output", "inv_prob_setup")
alg_settings_dir <- file.path(experiment_dir, "output", "alg_settings")
plt_dir <- file.path(out_dir, "plots")

# Source required files.
source(file.path(src_dir, "general_helper_functions.r"))
source(file.path(src_dir, "statistical_helper_functions.r"))
source(file.path(src_dir, "inv_prob_test_functions.r"))
source(file.path(src_dir, "plotting_helper_functions.r"))
source(file.path(src_dir, "mcmc_helper_functions.r"))
source(file.path(src_dir, "seq_design.r"))
source(file.path(src_dir, "gp_helper_functions.r"))
source(file.path(src_dir, "gpWrapper.r"))
source(file.path(src_dir, "llikEmulator.r"))
source(file.path(base_dir, "scripts", "helper", "sim_study_functions.r"))
source(file.path(base_dir, "..", "sipnet_calibration", "src", "prob_dists.r"))
source(file.path(base_dir, "..", "sipnet_calibration", "src", "eki_pecan.r"))
```

# MCMC Diagnostics
```{r}
# Read data/plots saved to file.
samp_dt <- fread(file.path(out_dir, "samp_exact.csv"))
samp_dt_prior <- fread(file.path(out_dir, "prior_samp.csv"))
inv_prob <- readRDS(file.path(out_dir, "inv_prob_list.rds"))
test_info_prior <- readRDS(file.path(out_dir, "test_info_prior.rds"))
test_info_post <- readRDS(file.path(out_dir, "test_info_post.rds"))
em_settings <- readRDS(file.path(alg_settings_dir, "em_settings.rds"))

par_prior <- inv_prob$par_prior
llik_obj <- inv_prob$llik_obj
```


## Trace Plots
```{r}
trace_plots <- get_trace_plots(samp_dt, thin=10L)
for(plt in trace_plots) plot(plt)
```

## 1d Marginals
```{r}
hist_plots <- get_hist_plots(samp_dt, thin=10L)
for(plt in hist_plots) plot(plt)
```
```{r}
# Relative to prior.
samp_dt_comb <- combine_samp_dt(samp_dt, samp_dt_prior)
kde_plots <- get_1d_kde_plots(samp_dt_comb, test_label_baseline="prior")

for(plt in kde_plots) plot(plt)
```

## Rhat diagnostic
```{r}
rhat_info <- calc_R_hat(samp_dt)
print(rhat_info$R_hat_vals)
```

# Investigating the tails of the log-likelihood and log-posterior.

```{r}
# Prior in original and transformed space.
lprior <- get_lprior_dens(par_prior)
prior_list <- convert_par_info_to_list(par_prior)
par_maps <- get_par_map_funcs(prior_list)

# Construct density of transformed (unconstrained) variables.
lprior_phi <- function(phi) {
  par <- par_maps$inv(phi)
  log_det_J <- attr(par, "log_det_J")
  
  lprior(par) + log_det_J
}

# Adjust llik to account for parameter transformation.
llik_phi <- function(phi, ...) {
  llik_obj$assemble_llik(par_maps$inv(phi), ...)
}

# Log-unnormalized posterior density as function of transformed parameter.
lpost_phi <- function(phi) lprior_phi(phi) + llik_phi(phi)
lpost <- function(par) lprior(par) + llik_obj$assemble_llik(par)
```


```{r}
# Prepare points for plotting projections.
prior_bounds <- get_prior_bounds(par_prior, tail_prob_excluded=0.00001)
fixed_vals <- sample_prior(par_prior, n=5L)
input_grids <- get_input_grid_1d_projection(inv_prob$par_names, 
                                            X_fixed=fixed_vals,
                                            X_bounds=prior_bounds, 
                                            n_points_default=300L)

# In transformed space.
input_grids_phi <- list()
for(i in seq_along(input_grids)) {
  par_name <- names(input_grids)[i]
  input_grids_phi[[par_name]] <- list()
  
  for(j in seq_along(input_grids[[i]])) {
    input_grids_phi[[par_name]][[j]] <- par_maps$fwd(input_grids[[par_name]][[j]])
  }
}

names(input_grids_phi) <- colnames(input_grids_phi[[1]][[1]])
```

```{r}
# Log-Likelihood.
llik_extrap_plots <- llik_obj$plot_1d_proj_approx_lik(input_grids=input_grids)

for(plt in llik_extrap_plots) plot(plt)
```

```{r}
# Log-Posterior. 
lpost_extrap_plots <- llik_obj$plot_1d_proj_approx_lik(input_grids=input_grids,
                                                       shift_func_new=lprior)
for(plt in lpost_extrap_plots) plot(plt)
```

```{r}
# Log posterior as function of transformed parameter.
phi_plots <- plot_1d_proj(lpost_phi, input_grids=input_grids_phi)

for(plt in phi_plots) plot(plt)
```

```{r}
# Designs.

# Latin Hypercube.
design1 <- get_init_design_list(inv_prob, "LHS", 80)

```

```{r}
llik_em1 <- em_settings$em_llik$fit_em(design1, inv_prob)
```

```{r}
llik_em1_plt <- llik_em1$plot_1d_proj_approx_lik(input_grids=input_grids,
                                                 approx_type="mean",
                                                 shift_func_new=NULL,
                                                 adjustment="rectified")

for(plt in llik_em1_plt) plot(plt)
```

```{r}
test <- llik_em1$calc_quantiles(input_grids$KEXT[[3]], 0.2, adjustment="rectified")
  
head(test)
```

```{r}

Sig <- diag(llik_obj$lik_par, nrow=inv_prob$dim_obs, ncol=inv_prob$dim_obs)
fwd_eki <- function(U, ...) inv_prob$par_to_obs_op(U)

eki_results <- run_eki_pecan(drop(inv_prob$y), fwd_eki ,Sig, 
                             prior_list, n_itr=1L, U0=design1$input)

lpost_eki <- get_Gaussian_ldens_approx(eki_results, inv_prob$y,
                                       normalize=FALSE, transform=TRUE)
lpost_eki_phi <- get_Gaussian_ldens_approx(eki_results, inv_prob$y,
                                           normalize=FALSE, transform=FALSE)
```


```{r}
# Log posterior as function of transformed parameter.
plots_eki_phi <- plot_1d_proj(lpost_eki_phi, input_grids=input_grids_phi)

for(plt in plots_eki_phi) plot(plt)
```

```{r}
# Log posterior as function of untransformed parameter.
plots_eki <- plot_1d_proj(lpost_eki, input_grids=input_grids)

for(plt in plots_eki) plot(plt)
```


```{r}
eki_results8 <- run_eki_pecan(drop(inv_prob$y), fwd_eki ,Sig, 
                              prior_list, n_itr=8L, U0=design1$input)

samp_dt_comb <- append_samples_mat(samp_dt_comb, eki_results8$U, param_type="par",
                                   test_label="eki8")

test_kde <- get_1d_kde_plots(samp_dt_comb, test_label_baseline="prior")

for(plt in test_kde) plot(plt)
```

















